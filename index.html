<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ステガノグラフィ学習ツール（変換機能付き）</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f8f9fa; color: #333; }
        h1, h2 { border-bottom: 2px solid #dee2e6; padding-bottom: 10px; }
        .section { background: white; padding: 25px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; }
        
        /* 図1のスタイル */
        .pixel-grid { display: grid; grid-template-columns: repeat(5, 70px); gap: 5px; margin-top: 20px; }
        .pixel { 
            width: 70px; height: 70px; display: flex; align-items: center; justify-content: center; 
            font-size: 14px; font-weight: bold; border: 1px solid #ccc; cursor: crosshair;
            transition: transform 0.1s; border-radius: 4px;
        }
        .pixel:hover { transform: scale(1.05); border-color: #007bff; z-index: 10; }

        /* カスタム吹き出し（ツールチップ） */
        #tooltip {
            position: absolute; display: none; background: rgba(0, 0, 0, 0.85); color: white;
            padding: 10px; border-radius: 6px; font-size: 12px; pointer-events: none;
            z-index: 100; line-height: 1.4; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        #tooltip b { color: #51afef; }

        /* ステガノグラフィ操作 */
        canvas { border: 2px solid #333; display: block; margin: 15px 0; max-width: 100%; border-radius: 4px; }
        textarea { width: 100%; height: 80px; margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: none; }
        button { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-weight: bold; }
        button:hover { background: #0056b3; }
        .info { font-size: 0.85em; color: #666; margin-top: 10px; background: #eee; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>

<h1>デジタル画像とデータ埋め込みの学習</h1>

<div class="section">
    <h2>1. 図1の再現（数値変換ツールチップ付）</h2>
    <p>マス目にマウスを乗せてください。<b>上位ビット（左側の4桁）</b>が変わる列方向の変化と、<b>下位ビット</b>が変わる行方向の変化を比較できます。</p>
    
    <div id="figure1" class="pixel-grid"></div>
    <div id="tooltip"></div>
</div>

<div class="section">
    <h2>2. LSB法によるテキスト埋め込み体験</h2>
    <p>200×200画素の各画素の「最下位ビット」にデータを書き込みます。</p>
    
    <textarea id="messageInput" placeholder="ここに隠したい文字を入力...">このメッセージは画像の最下位ビット（LSB）に隠されています。見た目には分かりません。</textarea>
    <button onclick="embedMessage()">メッセージを画像に埋め込む</button>

    <canvas id="canvas"></canvas>
    
    <div style="margin-top:20px; border-top:2px dashed #eee; padding-top:20px;">
        <button style="background:#28a745;" onclick="extractMessage()">画像からメッセージを抽出</button>
        <p><b>【抽出結果】:</b></p>
        <div id="extractedMessage" style="background:#f1f3f5; padding:15px; min-height:1.5em; border-radius:4px; border-left:4px solid #28a745; word-break: break-all;"></div>
    </div>
</div>

<script>
    // --- ツールチップの制御 ---
    const tooltip = document.getElementById('tooltip');

    function showTooltip(e, hex) {
        const dec = parseInt(hex, 16);
        const bin = dec.toString(2).padStart(8, '0');
        // 上位4ビットと下位4ビットを強調
        const binFormatted = `<b>${bin.substring(0,4)}</b>${bin.substring(4)}`;
        
        tooltip.innerHTML = `
            16進数: 0x${hex}<br>
            10進数: ${dec}<br>
            2進数: ${binFormatted}<br>
            <small>(太字は上位4ビット)</small>
        `;
        tooltip.style.display = 'block';
        updateTooltipPos(e);
    }

    function updateTooltipPos(e) {
        tooltip.style.left = (e.pageX + 15) + 'px';
        tooltip.style.top = (e.pageY + 15) + 'px';
    }

    function hideTooltip() {
        tooltip.style.display = 'none';
    }

    // --- 図1の生成 ---
    const gridData = [
        ['FF','FE','FC','F8','F0'],
        ['EF','EE','EC','E8','E0'],
        ['CF','CE','CC','C8','C0'],
        ['8F','8E','8C','88','80'],
        ['0F','0E','0C','08','00']
    ];
    const gridContainer = document.getElementById('figure1');
    gridData.flat().forEach(hex => {
        const div = document.createElement('div');
        div.className = 'pixel';
        div.style.backgroundColor = `#${hex}${hex}${hex}`;
        div.style.color = parseInt(hex, 16) > 128 ? 'black' : 'white';
        div.textContent = hex;
        
        // イベントリスナー追加
        div.addEventListener('mouseover', (e) => showTooltip(e, hex));
        div.addEventListener('mousemove', updateTooltipPos);
        div.addEventListener('mouseout', hideTooltip);
        
        gridContainer.appendChild(div);
    });

    // --- ステガノグラフィロジック (前回の内容を維持) ---
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const size = 200;
    canvas.width = size;
    canvas.height = size;

    function initImage() {
        const imgData = ctx.createImageData(size, size);
        for (let i = 0; i < imgData.data.length; i += 4) {
            let val = (Math.floor(i / (size * 4)) / size) * 255;
            imgData.data[i] = val; imgData.data[i+1] = val; imgData.data[i+2] = val; imgData.data[i+3] = 255;
        }
        ctx.putImageData(imgData, 0, 0);
    }
    initImage();

    function embedMessage() {
        const text = document.getElementById('messageInput').value;
        const imgData = ctx.getImageData(0, 0, size, size);
        let binary = "";
        for (let i = 0; i < text.length; i++) {
            binary += text.charCodeAt(i).toString(2).padStart(16, '0');
        }
        binary += "0000000000000000"; 

        if (binary.length > imgData.data.length / 4) {
            alert("メッセージが長すぎます！"); return;
        }

        for (let i = 0; i < binary.length; i++) {
            if (binary[i] === '1') imgData.data[i * 4] |= 1;
            else imgData.data[i * 4] &= ~1;
        }
        ctx.putImageData(imgData, 0, 0);
        alert("埋め込み完了。");
    }

    function extractMessage() {
        const imgData = ctx.getImageData(0, 0, size, size);
        let binary = "";
        for (let i = 0; i < imgData.data.length / 4; i++) {
            binary += (imgData.data[i * 4] & 1).toString();
        }
        let extractedText = "";
        for (let i = 0; i < binary.length; i += 16) {
            let code = parseInt(binary.substr(i, 16), 2);
            if (code === 0 || isNaN(code)) break;
            extractedText += String.fromCharCode(code);
        }
        document.getElementById('extractedMessage').textContent = extractedText;
    }
</script>

</body>
</html>